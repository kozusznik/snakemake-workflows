common: {
  # ============================================================================
  # ============================================================================
  # yaml example file 
  #
  # DESCRIPTION: source file for cluster processing scripts
  #
  #      AUTHOR: Christopher Schmied, schmied@mpi-cbg.de
  #   INSTITUTE: Max Planck Institute of Molecular Cell Biology and Genetics
  #        BUGS:
  #       NOTES:
  #     Version: 3.4
  #     CREATED: 2015-06-01
  #    REVISION: 2015-04-27
  # ============================================================================
  # ============================================================================
  # 1. Processing switches
  #
  # Description: Use switches to decide which processing steps you need:
  # Options:  transformation_switch: "timelapse",
  #           goes directly into fusion after timelapse registration
  #
  #           transformation_switch: "timelapse_duplicate",
  #           for dual channel processing one channel contains the beads
  #           duplicates the transformation from the source channel to the 
  #           target channel
  #
  #           Switches between content based fusion and deconvolution
  #           fusion_switch: "deconvolution", > for deconvolution
  #           fusion_switch: "fusion", > for content based fusion
  # ============================================================================
  # Transformation switch:
  transformation_switch: "timelapse",
  # Fusion switch:
  fusion_switch: "deconvolution",
  # ============================================================================
  # 2. Define dataset
  #
  # Description: key parameters for processing
  # Options: General Settings
  #          Settings for .czi files
  #          Settings for .tif datasets
  # ============================================================================
  # 2.1. General Settings -------------------------------------------------------
  #
  # Description: applies to both .czi and tif datasets
  # Options: xml file name
  #          number of timepoints
  #          angles
  #          channels
  #          illuminations
  # ----------------------------------------------------------------------------
  hdf5_xml_filename: '"dataset_split"', 
  ntimepoints: 1,        # number of timepoints of dataset
  angles: "20,50,80,110,140,170",   # format e.g.: "0,72,144,216,288",
  channels: "488,561",     # format e.g.: "green,red", IMPORTANT: for tif 0,1 etc!
  illumination: "0",     # format e.g.: "0,1",
  #
  # 2.2. Settings for .czi files -----------------------------------------------
  #
  # Description: applies only to .czi dataset
  # Options: name of first czi file
  # ----------------------------------------------------------------------------
  first_czi: "8.czi", # use .czi suffix
  #
  # 2.3. Settings for .tif datasets --------------------------------------------
  #
  # Description: applies only to .tif dataset
  # Options: file pattern of .tif files:
  #          multi channel with one file per channel: 
  #          spim_TL{tt}_Angle{a}_Channel{c}.tif
  #          for padded zeros use tt 
  # ----------------------------------------------------------------------------
  image_file_pattern: 'img_TL{{t}}_Angle{{a}}.tif',
  multiple_channels: '"NO (one channel)"',         # '"YES (all channels in one file)"' or '"YES (one file per channel)"' or '"NO (one channel)"'
  # ============================================================================
  # 3. Detection and registration
  #
  # Description: settings for interest point detection and registration
  # Options: Single channel and dual channel processing
  #          Source and target for dual channel one channel contains the beads
  #          Interestpoints label
  #          Difference-of-mean or difference-of-gaussian detection
  # ============================================================================
  # reg_process_channel:
  # Single Channel: '"All channels"'
  # Dual Channel: '"All channels"'
  # Dual Channel one Channel contains beads: '"Single channel (Select from List)"'
  reg_process_channel: '"All channels"',
  #
  # Dual channel 1 Channel contains the beads: which channel contains the beads?
  # Ignore if Single Channel or Dual Channel both channels contain beads
  source_channel: "488", # channel that contains the beads
  target_channel: "561", # channel without beads
  # reg_interest_points_channel:
  # Single Channel: '"beads"'
  # Dual Channel: '"beads,beads"'
  # Dual Channel: Channel does not contain the beads '"[(DO NOT register this channel)],beads"'
  reg_interest_points_channel: '"nuclei-out,nuclei-out"',
  #
  # type of detection: '"Difference-of-Mean (Integral image based)"' or '"Difference-of-Gaussian"'
  type_of_detection: '"Difference-of-Gaussian"',
  # Settings for Difference-of-Mean
  # For multiple channels 'value1,value2' delimiter is ,
  reg_radius_1: '2',
  reg_radius_2: '3',
  reg_threshold: '0.005',
  # Settings for Difference-of-Gaussian
  # For multiple channels 'value1,value2' delimiter is ,
  sigma: '0.5,0.5',
  threshold_gaussian: '0.025,0.025',
  # ============================================================================
  # 4. Timelapse registration
  #
  # Description: settings for timelapse registration
  # Options: reference timepoint
  # ============================================================================
  reference_timepoint: '1',   # Reference timepoint
  # ============================================================================
  # 5. Weighted-average fusion
  #
  # Description: settings for content-based multiview fusion
  # Options: downsampling
  #          Cropping parameters based on full resolution
  # ============================================================================
  downsample: '1',    # set downsampling
  minimal_x: '274',   # Cropping parameters of full resolution
  minimal_y: '-17',
  minimal_z: '-423',
  maximal_x: '1055',
  maximal_y: '1928',
  maximal_z: '480',
  # ============================================================================
  # 6. Multiview deconvolution
  #
  # Description: settings for multiview deconvolution
  # Options: External transformation
  #          Deconvolution settings
  #
  # ============================================================================
  # 6.1. External transformation -----------------------------------------------
  #
  # Description: Allows downsampling prior deconvolution
  # Options: no downsampling: 
  #          external_trafo_switch: "_transform",
  #
  #          downsampling:
  #          external_trafo_switch: "_external_trafo",
  #          IMPORTANT: boundingbox needs to reflect this downsampling. 
  #
  #          Matrix for downsampling
  # ----------------------------------------------------------------------------
  #external_trafo_switch: "_transform",
  external_trafo_switch: "",
  #
  # Matrix for downsampling
  #matrix_transform: '"0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.0, 0.5, 0.0"',
  #
  # 6.2. Deconvolution settings ------------------------------------------------
  # 
  # Description: core settings for multiview deconvolution
  # Options: number of iterations
  #          Cropping parameters taking downsampling into account!
  #          Channel settings for deconvolution
  # ----------------------------------------------------------------------------
  iterations: '5',        # number of iterations
  
  # Bounding box settings
  #
  # Description: determines whether a pre-defined bounding box will be used or not
  # Options: "Use pre-defined Bounding Box"
  #            - requires "bounding_box_title"
  #          "Define manually"
  #            - requires particular coordinates to be set
  #bounding_box: '"Use pre-defined Bounding Box"',
  #bounding_box_title: '"My Bounding Box"',
  #allow_to_modify: '"No"',
  #minimal_x_deco: '1728',  # Cropping parameters: take downsampling into account
  #minimal_y_deco: '-5696',
  #minimal_z_deco: '-784',
  #maximal_x_deco: '3118',
  #maximal_y_deco: '-4709',
  #maximal_z_deco: '867',
  
  # PSF estimation settings
  #
  # Description: determines whether PSFs will be extracted from beads or from a file
  # Options: "Extract from beads"
  #            - requires "detections_to_extract_psf_for_channel" specified as follows:
  #               - Single Channel: '"beads"'
  #               - Dual Channel: '"beads,beads"'
  #               - Dual Channel one channel contains beads: '"[Same PSF as channel red],beads"'
  #            - requires "psf_size_x"
  #            - requires "psf_size_y"
  #            - requires "psf_size_z"
  #          "Provide file with PSF"
  #            - requires specified as follows:
  #            - requires "use_same_psf_for_all_channels"
  #               - Provided PSF files will be used for all channels: '"Yes"'
  #               - Provided PSF files are channel-specific: '"No"'
  #            - requires "transform_psfs"
  #               - PSFs should be transformed: '"Yes"'
  #               - PSFs should not be transformed: '"No"'
  #psf_estimation: '"Provide file with PSF"',
  #detections_to_extract_psf_for_channel: '"nuclei-out,nuclei-out"',
  #psf_size_x: '19',
  #psf_size_y: '19',
  #psf_size_z: '25',
  #use_same_psf_for_all_channels: '"Yes"',
  #transform_psfs: '"Yes"',
  
  # ============================================================================
  # Resave output
  #
  # Description: writes new hdf5 dataset for fusion output
  # Options: Naming pattern of output based on channel number
  #          Channel settings
  #          File name for resaving output into hdf5
  #          Pixel size > isotropic resolution
  #          Image type (16Bit from content-based fusion, 32Bit from deconvolution)
  # ============================================================================
  # Calibration
  manual_calibration_output: "Yes", # calibration override: No or Yes
  # pixel size of output: take downsampling into account!
  output_pixel_distance_x: 0.2859, 
  output_pixel_distance_y: 0.2859,
  output_pixel_distance_z: 0.2859,
  output_pixel_unit: 'um',
  # ============================================================================
  # 7. Software directories
  # 
  # Description: paths to software dependencies of processing
  # Options: Fiji location
  #          beanshell and snakefile diretory
  #          directory for cuda libraries
  #          xvfb setting
  #          sysconfcpus setting
  # ============================================================================
  # current working Fiji
  fiji-app: "/opt/Fiji.app/ImageJ-linux64 -Xss4m",
  # bean shell scripts and Snakefile
  bsh_directory: "/opt/snakemake-workflows/spim_registration/timelapse/",
  # Directory that contains the cuda libraries
  directory_cuda: "/sw/users/schmied/cuda/",
  # xvfb 
  fiji-prefix: "xvfb-run -a",
  sysconfcpus: "sysconfcpus -n",
  memory-prefix: "-Xmx"
  }
  
  # ============================================================================
  # 8. Fiji Resource settings
  # 
  # Description: number of cores and memory for Fiji
  # Options: number of cores
  #          memory in GB
  # ============================================================================
Fiji_resources: {
  # setting for hdf5 resave:
  num_cores_hdf5: 24,
  mem_hdf5: "20g",
  # setting for registration:
  num_cores_reg: 24,
  mem_reg: "40g",
  # setting for timelapse registration:
  num_cores_time: 24,
  mem_time: "50g",
  # settings for average fusion:
  num_cores_fusion: 24,
  mem_fusion: "50g", 
  # settings for deconvolution:
  num_cores_deco: 24,
  mem_deco: "110g",
  # settings for resaving of output:
  num_cores_output: 24,
  mem_output: "20g"
  }
  # ============================================================================
  # 9. Advanced settings
  # 
  # Description: advanced and manual settings for each processing step
  #              corresponds to each rule in the snakefile
  #     Options: define_xml_czi
  #              define_xml_tif
  #              resave_hdf5
  #              registration
  #              xml_merge
  #              timelapse
  #              dublicate_transformations
  #              fusion
  #              external_transform
  #              deconvolution
  #              hdf5_output
  # ============================================================================
  # ----------------------------------------------------------------------------
  # 9.1. define_xml_czi
  # ----------------------------------------------------------------------------
define_xml_czi: {
  bsh_file: "define_czi.bsh",       # .bsh script for defining .czi file
  manual_calibration_czi: "No", # calibration override: No or Yes
  czi_pixel_distance_x: '0.285901069641113',  # Manual calibration x
  czi_pixel_distance_y: '0.285901069641113',  # Manual calibration y
  czi_pixel_distance_z: '1.500000000000000',  # Manual calibration z
  czi_pixel_unit: "um",             # unit of manual calibration
  rotation_around: "Y-Axis",       # axis of acquistion
  apply_rotation_to_dataset: "Yes",
  fix_bioformats: "Yes"
  }
  
  # ----------------------------------------------------------------------------
  # 9.2. define_xml_tif
  # ----------------------------------------------------------------------------
define_xml_tif: {
  # Settings for ImageJ Opener
  manual_calibration_tif: "No", # calibration override: No or Yes
  pixel_distance_x: '0.285901069641113',  # Manual calibration x
  pixel_distance_y: '0.285901069641113',  # Manual calibration y
  pixel_distance_z: '1.500000000000000',  # Manual calibration z
  pixel_unit: "um",             # unit of manual calibration
  type_of_dataset: '"Image Stacks (LOCI Bioformats)"', # '"Image Stacks (ImageJ Opener)"' or '"Image Stacks (LOCI Bioformats)"'
  multiple_timepoints: '"YES (one file per time-point)"', # or NO (one time-point)
  multiple_angles: '"YES (one file per angle)"',          # or NO (one angle)
  multiple_illumination_directions: '"NO (one illumination direction)"', # or YES (one file per illumination direction)
  imglib_container: '"ArrayImg (faster)"',        # '"ArrayImg (faster)"'
  bsh_file: "define_tif_zip.bsh"
  }
  
  # ----------------------------------------------------------------------------
  # 9.3. resave_hdf5
  # ----------------------------------------------------------------------------
resave_hdf5: {
  # Resaves .tif or .czi data into hdf5
  # Subsampling and resolution settings for hdf5: data dependent
  hdf5_chunk_sizes: '"{{ {{32,32,4}}, {{32,32,4}}, {{16,16,16}}, {{16,16,16}} }}"',
  subsampling_factors: '"{{ {{1,1,1}}, {{2,2,1}}, {{4,4,1}}, {{8,8,1}} }}"',
  # Standard settings for cluster processing
  setups_per_partition: '0',
  timepoints_per_partition: '1',
  resave_timepoint: '"All Timepoints"',
  resave_angle: '"[Single channel (Select from List)] processing_channel=[488]"',
  resave_channel: '"0"',
  resave_illumination: '"All illuminations"',
  resave_tile: '"All tiles"',
  bsh_file: "export.bsh"
  }
  
  # ----------------------------------------------------------------------------
  # 9.4. registration
  # ----------------------------------------------------------------------------
registration: {
  # Processing setting for Difference-of-Gaussian detection
  # compute_on:'"GPU accurate (Nvidia CUDA via JNA)"'
  compute_on: '"CPU (Java)"',
  separableconvolution: '"libSeparableConvolutionCUDALib.so"',
  # Downsampling settings
  downsample_detection: "Yes", # "No" or "Yes"
  downsample_xy: '"Match Z Resolution (less downsampling)"',
  downsample_z: "1x",
  # Standard Settings for bead based registration
  label_interest_points: '"beads"',              
  reg_process_angle: '"All angles"',
  reg_process_illumination: '"All illuminations"',
  reg_process_tile: '"All tiles"',
  reg_process_timepoint: '"Single Timepoint (Select from List)"',
  subpixel_localization: '"3-dimensional quadratic fit"',
  detection_min_max: "find_maxima",
  type_of_registration: '"Register timepoints individually"',
  # Registration algorithm. No other methods currently supported. this one corresponds to former version's Fast 3D Geometric hashing.
  algorithm: '"Fast descriptor-based (rotation invariant)"',
  transformation_model: "Affine",
  allowed_error_for_ransac: '5',
  significance: '10',
  fix_tiles: '"Fix first tile"',
  map_back_tiles: '"Map back to first tile using rigid model"',
  model_to_regularize_with: "Rigid",
  lambda: '0.10',
  imglib_container: '"ArrayImg (faster)"',
  bsh_file: "registration.bsh"  # .bsh script for registration
  }

  # ----------------------------------------------------------------------------
  # 9.5. xml_merge
  # ----------------------------------------------------------------------------
xml_merge: {
  bsh_file: "xml_merge.bsh"
  }
  
  # ----------------------------------------------------------------------------
  # 9.6. timelapse
  # ---------------------------------------------------------------------------- 
timelapse: {
  # Standard settings for timelapse registration
  type_of_registration_timelapse: '"Match against one reference timepoint (no global optimization)"',
  timelapse_process_timepoints: '"All Timepoints"',
  bsh_file: "timelapse_registration.bsh"
  }
  
  # ----------------------------------------------------------------------------
  # 9.7. duplicate_transformations
  # ----------------------------------------------------------------------------
duplicate_transformations: {
  # If dual channel processing and only one channel contains beads
  # this allows you to duplicate the transformation for the 
  # channel that does not contain beas
  duplicate_which_transformations: '"Replace all transformations"', # mode of duplication
  bsh_file: "duplicate_transformations.bsh" # .bsh script for duplication
  }
  
  # ----------------------------------------------------------------------------
  # 9.8. fusion
  # ----------------------------------------------------------------------------
fusion: {
  # fused_image: '"Append to current XML Project"', does not work yet
  process_timepoint: '"Single Timepoint (Select from List)"',
  process_angle: '"All angles"',
  process_channel: '"All channels"',
  process_illumination: '"All illuminations"',
  imglib2_container_fusion: '"ArrayImg"', # For larger datasets use: '"[CellImg (large images)]"'
  interpolation: '"Linear Interpolation"',
  pixel_type: '"16-bit unsigned integer"',
  imglib2_data_container: '"ArrayImg (faster)"',
  process_views_in_paralell: '"All"',
  fused_image: '"Save as (compressed) TIFF stacks"', 
  bsh_file: "fusion.bsh"
  }
  # ----------------------------------------------------------------------------
  # 9.9. external_transform
  # ----------------------------------------------------------------------------
external_transform: {
  # Downsamples for deconvolution
  # channel setting: '"all_channels"'
  # channel_setting: '"green"',
  transform_timepoint: '"All Timepoints"',
  transform_angle: '"All angles"',
  transform_channel: '"All channels"',
  transform_illumination: '"All illuminations"',
  apply_transformation: '"Current view transformations (appends to current transforms)"',
  define_mode_transform: '"Matrix"',
  transformation: '"Rigid"',
  bsh_file: "transform.bsh"
  }
  
  # ----------------------------------------------------------------------------
  # 9.10. deconvolution
  # ----------------------------------------------------------------------------
deconvolution: {
  # Settings for GPU or CPU processing 
  # '"CPU (Java)"' or '"GPU (Nvidia CUDA via JNA)"'
  compute_on: '"CPU (Java)"',
  cudafourierconvolution: "libFourierConvolutionCUDALib.so", # GPU processing name of cuda library
  # Standard settings for deconvolution
  process_timepoint: '"Single Timepoint (Select from List)"',
  #process_angle: '"All angles"',
  #process_channel: '"All channels"',
  #process_illumination: '"All illuminations"',
  downsample_deco: '2',
  input: '"Cached"',
  weight: '"Cached"',
  # PSF init choice
  # '"Blurred, fused image (suggested, higher compute effort)"', or
  # '"Average intensity (higer compute effort)"', or
  # '"Approximated average intensity (fast option)"', or
  # '"From TIFF file (dimensions must match bounding box)"', or
  initialize_with: '"Blurred, fused image (suggested, higher compute effort)"',
  # PSF type choice
  # '"Efficient Bayesian - Optimization II (very fast, imprecise)"', or
  # '"Efficient Bayesian - Optimization I (fast, precise)"', or
  # '"Efficient Bayesian (less fast, more precise)"', or
  # '"Independent (slow, very precise)"'
  type_of_iteration: '"Efficient Bayesian - Optimization I (fast, precise)"',
  Tikhonov_parameter: '0.006',
  compute: '"in 512x512x512 blocks"',
  fast_sequential_iterations: '"Yes"',
  osem_acceleration: '1',
  # imglib2_container_deco: '"CellImg (large images)"',
  produce: '"Each timepoint & channel"',
  fused_image: '"Save as (compressed) TIFF stacks"',
  bsh_file: "deconvolution.bsh"
  }
  
  # ----------------------------------------------------------------------------
  # 9.11. hdf5_output
  # ----------------------------------------------------------------------------
hdf5_output: {
  # if data is 32Bit then the data is converted into 16Bit data
  convert_32bit: '"[Use min/max of first image (might saturate intenities over time)]"',
  # subsampling and chunk size settings: dataset dependent
  subsampling_output: '"{{ {{1,1,1}}, {{2,2,2}}, {{4,4,4}}, {{8,8,8}} }}"', # data dependent
  chunk_sizes_output: '"{{ {{16,16,16}}, {{16,16,16}}, {{16,16,16}}, {{16,16,16}} }}"', # data dependent
  # subsampling_output: '"{{ {{1,1,1}}, {{2,2,2}} }}"',
  # chunk_sizes_output: '"{{ {{16,16,16}}, {{16,16,16}} }}"',
  # Standard settings for hdf5_output
  output_type_of_dataset: '"Manual Loader (TIFF only, ImageJ Opener)"', # '"Manual Loader (TIFF only, ImageJ Opener)"' or '"Manual Loader (Bioformats based)"'
  output_multiple_timepoints: '"YES (one file per time-point)"',
  output_illumination_directions: '"NO (one illumination direction)"',
  output_multiple_angles: '"NO (one angle)"',
  output_multiple_tiles: '"NO (one tile)"',
  output_imglib_container: '"ArrayImg (faster)"',
  bsh_file_define: "define_output.bsh", # .bsh script for defining the dataset
  bsh_file_hdf5: "export_output.bsh"    # .bsh script for resaving into hdf5
  }

